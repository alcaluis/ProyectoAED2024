---
title: ProyectoAED2024
subtitle: "Análisis Exploratorio de Datos. Máster en Ciencia de Datos - UV"
authors:
  - name: LUIS ALBACETE CABALLERO
  - name: CARLOS RIBES GARCÍA
  - name: JOAN PEDRO BRUIXOLA
affiliation:
  - num: 1
    address: |
      Universitat de València. ETSE.
    email: alcaluis@alumni.uv.es
  - num: 2
    address: |
      Universitat de València. ETSE.
    email: carigar4@alumni.uv.es
  - num: 3
    address: |
      Universitat de València. ETSE.
    email: jopebrui@alumni.uv.es
authorcitation: |
  Albacete, L; Ribes, C; Pedro, J.
simplesummary: |
  Estudio de los delitos causados por menores en España entre 2013 y 2023.
abstract: |
  Proyecto de tratamiento de datos para la asignatura de Análisis exploratorio
  de datos. El tópico es la delincuencia en España provocado por menores de entre
  14 y 17 años (ambos inclusives). Donde se estudiarán los delitos causados con
  mayor frecuencia.
keywords: |
  Delito; Delincuencia; Menores; Datos; Ciencia de Datos;
authorcontributions: |
  WIP. En que hemos contribuido cada uno.
output: 
  rticles::mdpi_article:
    extra_dependencies: longtable
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      out.width="100%",
                      warning=FALSE)
```

# Introducción

## Definición proyecto y planteamiento de preguntas (objetivos)

La delincuencia en España es un tema de conversación latente. Un estudio importante, es tener en cuenta la edad del delincuente. En este estudio analizaremos los diferentes tipos de delito ocasionados por menores de entre 14 y 17 años durante los 10 últimos años. Los objetivos del estudio es responder a las siguientes preguntas:

1. ¿Cuáles son los delitos más frecuentes y que edades los perpetran? ¿Han aumentado o han disminuido en los últimos años?
2. Analizar los picos de delitos y relacionarlos con hechos reales. (Buscar sucesos, leyes)
3. Encontrar tendencias entre los años.
4. ...

WIP: Definir el problema y los objetivos del estudio

## Carga de librerías y datos
```{r intro_setup_carga, echo=TRUE}
# Carga de librerias
librerias <- c("readr",       # Lectura de ficheros con formato
               "dplyr",       # Gramática de manipulación de datos
               "ggplot2",     # Visualización mediante gráficas elegantes
               "kableExtra",  # Kable para ajutar las tablas
               "visdat",      # Visualizacion de valores faltantes
               "stringr")     # Operaciones con caracteres
pacman::p_load(char=librerias)

# Carga de datos
col_names <- c("delitos_n1", "delitos_n2", "delitos_n3",
               "delitos_n4", "delitos_n5", "edad",
               "año", "total_delitos")

delitos_menores_raw <- read_delim(
  file = "../data/delitos_menores_2013_2023.csv", 
  delim = ";",
  escape_double = FALSE,
  trim_ws = TRUE,                        # Espacios y tabulaciones eliminados.
  show_col_types = FALSE,                # Omitir mensajes en carga de datos.
  col_names = col_names,                 # Si proporcionamos nombres de columnas hemos de
                                         # saltarnos la primera fila (skip=1).
  skip = 1,
  locale = locale(grouping_mark = "."))  # Locale nos permitirá leer debidamente
                                         # los millares.
```

## Estudio y acondicionamiento de los datos

### Análisis de la estructura y valores iniciales de los datos.

Comenzamos ejecutando "summary" del conjunto de datos, recien cargado, para analizarlo.

```{r intro_analisis_inicial_1}
# Análisis de la estructura y valores iniciales de los datos.
summary(delitos_menores_raw)
# str(delitos_menores_raw)     # STR no nos aporta información adicional
# glimpse(delitos_menores_raw) # Lo mismo sucede con GLIMPSE
```
Gracias a "summary" podemos apreciar qué columnas numéricas contienen NAs y si los valores (de las columnas numéricas) entran dentro de lo esperado (min, max, median, ...).

Teniendo para la columna **año** valores esperados, desde 2013 hasta 2023 y la media obviamente en 2018. Respecto a la columna **total_delitos**, podemos apreciar que tiene un número relevante de valores faltantes (210) y confirmamos que los valores se han importado correctamente (manteniendo los millares). Además hemos identificado que la columna **edad** se ha importado como tipo "character". Tras hacer una visualización del archivo nos damos cuenta que los años se han importado como "14 años" agregando el sustantivo para todos los valores y en algunos casos agregando un "Total". Acondicionamiento de la columna será necesario.

Las columnas restantes, que son de tipo "character", representan el delito en distintos niveles de clasificación. Habremos de factorizar estas variable categóricas. El uso de la función "str" o "glimpse" en este caso no nos ha aportado información adicional.

A continuación, ejecutaremos "table" por columna para analizar la cantidad de "NA" y si hay variedad en los elementos. 

```{r intro_analisis_inicial_2}
# 1. delitos_n1
cat("Columna 'delitos_n1':")
(table(delitos_menores_raw$delitos_n1, useNA = "always"))

# 2. delitos_n2
cat("Columna 'delitos_n2':") 
(table(delitos_menores_raw$delitos_n2, useNA = "always"))

# 3. delitos_n3, N4, N5
cat("Columna 'delitos_n3,4,5' (últimos 5):")
(tail(table(delitos_menores_raw$delitos_n3, useNA = "always"), 5))
(tail(table(delitos_menores_raw$delitos_n4, useNA = "always"), 5))
(tail(table(delitos_menores_raw$delitos_n5, useNA = "always"), 5))

# 4. edad
cat("Columna 'edad':")
(table(delitos_menores_raw$edad, useNA = "always"))

# 5. año
cat("Columna 'año':")
(table(delitos_menores_raw$año, useNA = "always"))
```
De las diferentes columnas podemos decir que:

* **delitos_n1**: la primera columna no nos aporta valor alguno al solo tener un valor. Más adelante será eliminada.
* **delitos_n2**: esta columna nos servirá para hacer el primer filtrado y quedarnos con solo los delitos y faltas cometidas. Omitiendo los totales calculados. Sus valores pueden ser reemplazados en valores más claros.
* **delitos_n3, n4, y n5**: ayudan a clasificar los delitos en subtipos de infracción. Sin embargo, podemos ver como a mayor nivel de detalle más valores faltantes. Esto se debe a que un nivel de clasificación tan preciso no es necesario para describir todos los delitos.

La columna **delitos_n5** no será necesaria. Aporta muy poca información y el análisis no requerirá tanto nivel de detalle para una infracción.

* **edad**: todos los datos de esta columna son uniformes y esperados (ningún valor faltante). Finalmente se eliminarán aquellas instancias que representen un total y se convertirá la columna a tipo numérico.

* **total**: respecto a esta columna pese a que no hayamos utilizado ninguna instrucción, hemos mediante visualización del fichero analizado un caso en concreto para definir la naturaleza de esta columna. Ya vimos anteriormente, gracias a otras columnas, que hay agrupaciones internas de los datos calculando los totales. Pero eso no es todo. Podemos apreciar que el total de un delito, es la suma de todas sus subclasificaciones.

```{r intro_analisis_inicial_3}
# 6. total_delitos
df_total_delitos <- delitos_menores_raw %>%
  filter(startsWith(delitos_n3, "13")) %>%
  filter(edad=="14 años") %>%
  filter(año==2013) %>%
  mutate(delitos_n4 = ifelse(!is.na(delitos_n4),
                             substring(delitos_n4, 1, 4),
                             NA))

knitr::kable(df_total_delitos[c(4,5,8)], format = "latex", 
             booktabs = TRUE, 
             caption = "Caso delitos 'Contra el patrimonio y el orden 
                        socioeconómico' en 2013 por delincuentes de 14 años", 
             align = 'lll', centering = TRUE,
             table.envir = "table", position = "H")

```

Como podemos observar, el total de "13.2 Robos", es igual a la suma de "13.2.1" y "13.2.2", a su vez el delito contra el patrimonio es la suma de los delitos "13.1", "13.2", ... Este hecho agrega redundancia a los datos. Por ende no solo tendremos que eliminar las filas que representen totales, valor "total" en edad, pero también aquellas filas que son las agrupaciones de otras con el objeto de tener un conjunto __Tidy__.

En resumen, las columnas de delitos n1 y n5 no son necesarias y pueden ser eliminadas sin problemas.Ya que hemos averiguado que los delitos de N5 se suman para los delitos de N4, es decir no perdemos datos. Las columnas de clasifiación de delitos restantes serán convertidas a factor. La columna edad será modificada para mayor fidelidad al dato y un adecuado uso más adelante. 

### Acondicionamiento y preparación de los datos
```{r intro_acondicionamiento, echo=TRUE}
df_delitos_menores <- delitos_menores_raw %>%
  # Retiramos las filas que se dividan/clasifiquen hasta el nivel 5
  filter(is.na(delitos_n5)) %>%
  filter(!is.na(delitos_n3)) %>%
  # Selección de características/variables relevantes
  select(-c(delitos_n1, delitos_n5)) %>%

  # Renombramiento de las columnas
  rename(delito_falta = delitos_n2,          # Delito o Falta
         clasi_infrac = delitos_n3,          # Primer nivel de clasifiación
         sub_clasi_infrac = delitos_n4) %>%  # Segundo nivel de clasifiación
  
  # Filtrado, retiramos las columnas que ya están pre-calculadas.
  # Caso edad = "Total"
  # Caso "nivel_n1" era un "total" y los demás niveles de delito "NA"
  # Caso "nivel_n2" era un "total"
  filter(edad != "Total") %>%
  filter(!is.na(delito_falta)) %>%
  filter(!is.na(clasi_infrac)) %>%
  
  # Reemplazo de valores
  mutate(
    # valores entendibles para "delito_falta"
    delito_falta = case_when(delito_falta == "A Delitos" ~ "Delito",
                             delito_falta == "B Faltas" ~ "Falta"),
    # Eliminamos " años" y pasamos a numérico
    edad = as.numeric(substring(edad, 1, 2))
  ) %>%
  
  # Convertimos a factores
  mutate(
    delito_falta = as.factor(delito_falta),
    clasi_infrac = as.factor(clasi_infrac),
    sub_clasi_infrac = as.factor(sub_clasi_infrac)
  )

# Eliminamos las filas con los totales de las subcategorías
seleccion <- c()

for (type in unique(df_delitos_menores$clasi_infrac)){
  vectoraux <-
    df_delitos_menores$sub_clasi_infrac[df_delitos_menores$clasi_infrac==type]

  if (sum(!is.na(vectoraux) > 0 )) {
      seleccion <- c(seleccion, !is.na(vectoraux))
  } else {
      seleccion <- c(seleccion, rep(TRUE, times=length(vectoraux)))
  }
}

df_delitos_menores <- df_delitos_menores[seleccion,]

# Añadimos una columna con los identificadores estilizados

ident <- sub( " .*" , "" ,unique(df_delitos_menores$clasi_infrac))
ident[13:16]<- c("vsPer", "vsPat", "vsInterGnrl", "vsOrdPub")
names(ident)<- unique(df_delitos_menores$clasi_infrac)
ident<- ident[df_delitos_menores$clasi_infrac]

df_delitos_menores <- df_delitos_menores %>%
  mutate(id_clasi = ident)
```

\startlandscape

### Code Book

```{r intro_codebook}
columnas <- c("Nombre", "Tipo", "Valores",
              "Descripción", "Comentarios")
celdas <- c("delito_falta",     "caracter", "delito, falta", "-", "-",
            "clasi_infrac",     "caracter", "Diferentes tipos de delito (primer nivel de clasificación).", "-", "-",
            "sub_clasi_infrac", "caracter", "Diferentes tipos de delito (segundo nivel de clasificación).", "-", "Pueden no ser necesarios tal nivel de detalle teniendo valores nulos en ese caso.",
            "edad",             "numerico",  "[14, .., 17]", "Edad del infractor.", "Edad en años. No deberían haber valor faltantes.",
            "año",              "numerico",  "[2013, .., 2023]", "Año del recuento de delitos.", "Años expresados en 4 cifras. No deberían haber valor faltantes.",
            "total_delitos",    "numerico",  "[0, ..]", "Número total de delitos realizados por los infractores de una edad. ", "Si hay valores faltantes se considerarán 0.")

mat_celdas <- matrix(celdas, ncol=5, byrow=TRUE)

knitr::kable(mat_celdas,
             longtable=TRUE,
             col.names = columnas,
             format = "latex", 
             booktabs = TRUE,
             caption = "Code Book (Delitos)", 
             align = 'lll') %>%
  column_spec(3:5, "6cm")
```
\finishlandscape


# Análisis

## Análisis de las variables
```{r analisis_variables_1}
# WIP:
#   - Análisis de las variables (individualmente, explicación de los datos,
#                                estadísticos.) (CARLOS)
df_delitos_tipo <- df_delitos_menores %>%
  #filter(clasi_infrac== "3 Lesiones")%>%
  group_by(año,clasi_infrac) %>%
  mutate(suma_por_tipo = sum(total_delitos,na.rm=TRUE)) %>%
  ungroup(año) %>%
  mutate(suma_decada_por_tipo = sum(total_delitos,na.rm=TRUE)) %>%
  arrange( desc(suma_decada_por_tipo))


EvolucionTiempoSegunDelito<- ggplot( data = df_delitos_tipo, aes(x=año, y=suma_por_tipo) )+
  geom_line()+
  #geom_area()+
  labs(x = "Año", y = "Suma por Tipo")+
  facet_wrap(~factor(clasi_infrac, levels = as.character(unique(clasi_infrac)) ) , scales = "free_y",ncol=4) 
EvolucionTiempoSegunDelito

BoxPlotSegunDelito <- ggplot( data = df_delitos_tipo, aes(x=año, y=suma_por_tipo))+
  geom_boxplot()+
  labs(x = "Año", y = "Suma por Tipo")+
  facet_wrap(~factor(clasi_infrac, levels = as.character(unique(clasi_infrac))), scales = "free_y",ncol=4)+
  theme_bw() +
  theme(axis.text.y = element_text(size=8), axis.text.x = element_text(size=6))+
  scale_x_continuous(breaks = seq(2013, 2023, by = 2),limits = c(2013,2023),label = as.character(seq(13,23,by=2)))+
  ggtitle("Evolución en el tiempo según tipo de delito")
BoxPlotSegunDelito


df_delitos_summary_por_tipo <- df_delitos_menores %>%
  group_by(clasi_infrac, año) %>%
  summarise(total_anual = sum(total_delitos, na.rm=TRUE),
            .groups = 'keep') %>%
  ungroup(año) %>%
  summarise(d.mean = mean(total_anual, na.rm=TRUE),
            d.sd = sd(total_anual, na.rm=TRUE),
            d.Q1 = quantile(total_anual, 0.25, na.rm =TRUE),
            d.Q2_median = quantile(total_anual, 0.5, na.rm =TRUE),
            d.Q3 = quantile(total_anual, 0.75, na.rm =TRUE)) 

head(df_delitos_summary_por_tipo)

```

```{r, Version Explicativa}
EvolucionTiempoSegunDelito<- ggplot( data = df_delitos_tipo, aes(x=año, y=suma_por_tipo, fill  = suma_decada_por_tipo ))+
  geom_area(alpha=0.85) +
  geom_line(color = "#444444", size=1, alpha = 0.5)+
  geom_point(color = "#444444", alpha = 0.7, size = 0.75)+

  labs(x = "Año", y = "Suma por Tipo", fill= "Suma Total (década) por Tipo")+
  facet_wrap(~factor(clasi_infrac, levels = as.character(unique(clasi_infrac)) ) , scales = "free_y",ncol=4 ) +
 # A partir de aquí estético
  theme_bw() +
  scale_y_continuous(expand = expansion(mult = c(0.05, 0.05)))+
  scale_color_gradient(low = "blue", high = "red")+
  scale_fill_gradient(low = "blue", high = "red")+
  theme(axis.text.y = element_text(size=8), axis.text.x = element_text(size=6))+
  scale_x_continuous(breaks = seq(2013, 2023, by = 2),limits = c(2013,2023),label = as.character(seq(13,23,by=2)))+
  ggtitle("Evolución en el tiempo según tipo de delito")

EvolucionTiempoSegunDelito

```

Observamos aquí una visualización de la evolución de la cantidad de delitos a lo largo del tiempo según tipo de delito. Se pueden observar varias irregularidades:

## 1. Valle ( descenso puntual ) de varios tipos de delito entre el 2020 y 2021.
Las tipos de delito:

###  3. Lesiones
###  6. Contra la libertad
###  7. Torturas e integridad social (++)
###  8. Contra la libertad e indemnidad sexuales
### 13. Contra el patrimonio y el orden socioeconómico
### 17. Contra la seguridad colectiva 
### 18. Falsedades (++)
### 20. Contra la administración de Justicia
###  R. Resto de delitos

muestran un valle significativo ( especialmente tipo 7 y 18 ) que viene probablemente provocado por el contexto social contemporáneo a los eventos: la crisis del coVID-19 y la cuarentena. 
Estos sucesos provocaron la cancelación de la mayor parte del sector laboral español y de la totalidad de las escuelas, que pasaron a un formato online.

Es fácil imaginar así que estos tipos de delitos, de naturaleza más escolar y/o física, tengan un descenso en número ante la situación pandémica.

Otro gráfico que nos puede desvelar cierta información es el de delitos totales según edad:
```{r analisis_variables_2}
df_delitos_edad <- df_delitos_menores %>%
  mutate(edad = factor(edad)) %>%
  group_by(año,edad)%>%
  summarize(suma_por_edad = sum(total_delitos,na.rm=TRUE))

totales_por_edad<-ggplot( data = df_delitos_edad, aes(x=año, y=suma_por_edad,color = edad)) +
  geom_line(size = 1)+
  geom_point()+
  labs(x = "Año", y = "Suma por Edad")+
  theme(axis.text.y = element_text(size=8), axis.text.x = element_text(size=6)) +
  scale_x_continuous(breaks = seq(2013, 2023, by = 2),limits = c(2013,2023),label = as.character(seq(13,23,by=2)))+
  ggtitle("Evolución en el tiempo de delitos totales segun edad")

totales_por_edad
  
```

De nuevo se hace evidente el valle ocasionado por la pandemia y también una aparente correlación lineal positiva entre la edad y el total de delitos.
```{r}
# Suponiendo que ya tienes tus data frames df_delitos_edad y df_totales_calculados

df_media <- df_delitos_edad %>%
  ungroup(edad) %>%
  summarise( delitos_por_año_entre_4 = sum(suma_por_edad,na.rm = TRUE)/4 )
# Añadir una columna para distinguir los tipos de datos
ggplot() +
  geom_line(aes(x=año, y = suma_por_edad, color = edad), data = df_delitos_edad, size = 1) + 
  geom_point(aes(x=año, y = suma_por_edad, color = edad), data = df_delitos_edad, size = 1) + # Delitos por edad
  geom_line(aes(x=año,y = delitos_por_año_entre_4) , data = df_media, size = 1, linetype = "dashed", color = "black") +  # Total delitos
  labs(x = "Año", y = "Suma") +
  scale_x_continuous(breaks = seq(2013, 2023, by = 2), limits = c(2013, 2023), labels = as.character(seq(13, 23, by = 2))) +
  ggtitle("Evolución de Delitos Totales y por Edad")+
  annotate("text", x = 2021, y = 5000, 
           label = "Suma / 4", 
           color = "black", size = 4, hjust = 0.25)+
  geom_curve(aes(x = 2021, xend = 2020.7, y = 5150, yend = 5800), 
               arrow = arrow(type = "closed", length = unit(0.1, "inches")), 
               color = "black", size = 1)
```

```{r analisis_variables_3}

#   - Análisis de las variables (relaciones) (JOAN)
# 
#
# - NOTA: Se debe hacer uso de una "Visualización temprana (exploratoria)"
#   de los datos. 
# - NOTA: Junto a la visualización se debe aportar una explicación.
```

En primer lugar, estudiaremos la distribución de delitos y faltas a lo largo de los años. El siguiente gráfico de barras permite visualizar la cantidad total de incidentes entre 2013 y 2023.


```{r}
# Filtramos para quedarnos con el total de delitos y faltas por año.

total_infrac_años <- df_delitos_menores %>%
  filter(!is.na(año) & !is.na(delito_falta) & !is.na(total_delitos)) %>% # Quitamos los NA's
  group_by(año, delito_falta) %>%  # Agrupamos segun el tipo de infracción
  summarise(total = sum(total_delitos), .groups = 'drop')  # Sumar el total de infracciones

print(total_infrac_años)


```

```{r}

ggplot(data = total_infrac_años, aes(x = año, y = total, fill = delito_falta)) + 
  geom_bar(stat = "identity", position = "dodge") + 
  labs(title = "Distribución de Delitos vs. Faltas por Año", 
       x = "Año", 
       y = "Total de Incidencias") + scale_x_continuous(breaks = seq(min(df_delitos_menores$año), max(df_delitos_menores$año), by = 1))

```
Como podemos observar, hay una clara tendencia creciente de los delitos de menores desde el 2016 hasta el 2019. En el 2020 hay una gran disminución de delitos. Esto se debe, sin duda, a la cuarentena que hubo durante la pandemia del COVID-19. Pero, a partir del 2021, notamos que la cantidad de delitos vuelve a subir, tomando unas cifras similares a las del 2019. En general, podemos observar un notable aumento de delitos juveniles en los últimos diez años. Por otra parte, notamos que el número de faltas va disminuyendo hasta el año 2017, y a partir del 2018 no hay registros sobre faltas.

Esta tendencia de aumento de delitos y disminución de faltas puede deberse a diferentes motivos. El cambio mas notable se observa entre el 2015 y el 2016. Este fenómeno puede deberse a la reforma del Código Penal en España del 2015, en la cual se llevó a cabo la supresión de muchas infracciones consideradas faltas, que pasaron a ser clasificadas como delitos leves. Esto explicaría el aumento de delitos en contraposición con la disminución de faltas a partir del año 2015. 

Por otra parte, podemos estudiar como se distribuyen las infracciones segun su tipo. El gráfico que veremos a continuación nos permite observar la evolución de cada tipo de infracción en los últimos diez años, así como cuales son las infracciones mas o menos frecuentes.


```{r}

delitos_clasi <- df_delitos_menores %>%
  filter(!is.na(año) & !is.na(total_delitos)) %>% # Quitamos los NA's
  group_by(año, clasi_infrac) %>%  # Agrupamos segun el tipo de infracción
  summarise(total = sum(total_delitos), .groups = 'drop')  # Sumar el total de infracciones

print(delitos_clasi)

```


```{r}


ggplot(data = delitos_clasi, aes(x = año, y = total)) + 
  geom_bar(stat = "identity") +
  labs(title = "Delitos por clasificación", 
       x = "Año", 
       y = "Total de Delitos") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),strip.text = element_text(size = 6)) + facet_wrap(~clasi_infrac, scales='free_y' )


```
Observamos que los mas frecuentes son los delitos contra el patrimonio y el orden socioeconómico, junto con los delitos por lesiones. Además se puede apreciar un aumento en estos últimos a partir del 2016, una tendencia que también se refleja en los delitos contra la libertad. Este cambio probablemente está relacionado con la reforma del Código Penal mencionada antes, ya que a partir de este año también se reduce drásticamente el número de faltas contra las personas. Es probable que, tras la reforma, muchas conductas como agresiones físicas leves, amenazas o coacciones, que antes se consideraban faltas pasaron a considerarse delitos por lesiones y contra la libertad, respectivamente.  Este mismo razonamiento puede aplicarse a la disminución de faltas contra el patrimonio y contra el orden público frente al aumento de delitos en estos ámbitos. 

Además, se observa un aumento alarmante en los delitos de homicidio en los últimos dos años. Esta tendencia podría explicarse por varias razones. Una de ellas es la mayor exposición de los menores a situaciones violentas, que puede estar relacionada con problemas sociales, la influencia de entornos familiares problemáticos o la fácil accesibilidad a contenido violento en línea. Otra posible explicación son los cambios en la legislación y el enfoque de la justicia juvenil, ya que algunos sostienen que la percepción de impunidad puede motivar a los jóvenes a cometer delitos más graves.

Asimismo, destaca el aumento de los delitos contra la intimidad y el derecho a la propia imagen. Esta tendencia probablemente está vinculada al mayor uso de dispositivos digitales y redes sociales entre menores. Observamos un pico en 2020, lo cual es comprensible, ya que durante el confinamiento se incrementó el uso de redes sociales, lo que pudo haber llevado a más incidentes de violación de la privacidad digital, como la difusión no consentida de contenido privado o el ciberacoso.

Es importante mencionar que hay ciertos delitos que no son significativos para su análisis debido a su escaso número de registros, lo que les resta importancia, como sucede con las falsedades y las faltas contra intereses generales.

Por otro lado, como hemos mencionado anteriormente, algunos delitos cuentan con subclasificaciones. Esto es porque ciertas categorías son demasiado amplias. Por ejemplo, un robo y un hurto son distintos: el primero implica el uso de la fuerza o amenazas, mientras que el segundo no. Ambos, sin embargo, se consideran delitos contra el patrimonio y el orden socioeconómico. Por esta razón, es importante examinar cómo se distribuyen estas subclasificaciones. A continuación, utilizaremos gráficos de barras apiladas para analizar estas distribuciones.


```{r}

delitos_subclasi_13 <- df_delitos_menores %>%
  filter(!is.na(año) & !is.na(total_delitos) & !is.na(sub_clasi_infrac)) %>%  # Quitamos los NA's
  group_by(año, clasi_infrac, sub_clasi_infrac) %>%  # Agrupamos por año y subclasificación
  summarise(total = sum(total_delitos), .groups = 'drop') %>%  # Sumar el total de infracciones
  filter(clasi_infrac == "13 Contra el patrimonio y el orden socioeconómico")  # Filtrar solo el tipo de delito deseado

print(delitos_subclasi_13)

```

```{r}

ggplot(data = delitos_subclasi_13, aes(x = año, y = total, fill = sub_clasi_infrac)) + 
  geom_bar(stat = "identity") +
  labs(title = "13 Contra el patrimonio y el orden socioeconómico", 
       x = "Año", 
       y = "Total de Delitos") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        strip.text = element_text(size = 6))
  

```

Como podemos observar, los delitos contra el patrimonio mas frecuentes son los robos y los hurtos.

Otros delitos frecuentes entre menores son aquellos clasificados como delitos contra la seguridad colectiva.

```{r}

delitos_subclasi_17 <- df_delitos_menores %>%
  filter(!is.na(año) & !is.na(total_delitos) & !is.na(sub_clasi_infrac)) %>%  # Quitamos los NA's
  group_by(año, clasi_infrac, sub_clasi_infrac) %>%  # Agrupamos por año y subclasificación
  summarise(total = sum(total_delitos), .groups = 'drop') %>%  # Sumar el total de infracciones
  filter(clasi_infrac == "17 Contra la seguridad colectiva")  # Filtrar solo el tipo de delito deseado

print(delitos_subclasi_17)

```

```{r}

ggplot(data = delitos_subclasi_17, aes(x = año, y = total, fill = sub_clasi_infrac)) + 
  geom_bar(stat = "identity") +
  labs(title = "17 Contra la seguridad colectiva", 
       x = "Año", 
       y = "Total de Delitos") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        strip.text = element_text(size = 6))
  
```
Observamos que las subcategorías más comunes incluyen, en primer lugar, los delitos contra la seguridad vial, seguidos de los delitos contra la salud pública. Ejemplos de delitos contra la seguridad vial son la conducción bajo los efectos del alcohol, la conducción temeraria y el uso de vehículos sin licencia. Por otro lado, algunos ejemplos de delitos contra la salud pública son el tráfico de drogas y la contaminación ambiental.


Además, podemos notar una ligera disminución en los delitos contra la administración de justicia desde 2020. A continuación, analizaremos cómo se distribuyen las subclasificaciones dentro de esta categoría.


```{r}

delitos_subclasi_20 <- df_delitos_menores %>%
  filter(!is.na(año) & !is.na(total_delitos) & !is.na(sub_clasi_infrac)) %>%  # Quitamos los NA's
  group_by(año, clasi_infrac, sub_clasi_infrac) %>%  # Agrupamos por año y subclasificación
  summarise(total = sum(total_delitos), .groups = 'drop') %>%  # Sumar el total de infracciones
  filter(clasi_infrac == "20 Contra la Administración de Justicia")  # Filtrar solo el tipo de delito deseado

print(delitos_subclasi_20)

```

```{r}

ggplot(data = delitos_subclasi_20, aes(x = año, y = total, fill = sub_clasi_infrac)) + 
  geom_bar(stat = "identity") +
  labs(title = "20 Contra la Administración de Justicia", 
       x = "Año", 
       y = "Total de Delitos") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        strip.text = element_text(size = 6))


```

Notamos que los delitos que disminuyen a partir del 2020 son los de quebrantamiento de condena. Esta reducción puede deberse a diversas causas. Una posibilidad es que la introducción de tecnologías, como pulseras electrónicas o controles virtuales, haya mejorado la supervisión del cumplimiento de las condenas. También es posible que se hayan implementado políticas de reintegración social que favorezcan el cumplimiento de condenas más que la sanción de quebrantamientos. Esto puede incluir programas de rehabilitación o alternativas al encarcelamiento que se enfocan en apoyar a los condenados en lugar de castigar severamente los incumplimientos.


Por otra parte, en los delitos contra el orden público, se puede observar un pico en los años 2021 y 2022.


```{r}

delitos_subclasi_22 <- df_delitos_menores %>%
  filter(!is.na(año) & !is.na(total_delitos) & !is.na(sub_clasi_infrac)) %>%  # Quitamos los NA's
  group_by(año, clasi_infrac, sub_clasi_infrac) %>%  # Agrupamos por año y subclasificación
  summarise(total = sum(total_delitos), .groups = 'drop') %>%  # Sumar el total de infracciones
  filter(clasi_infrac == "22 Contra el orden público")  # Filtrar solo el tipo de delito deseado

print(delitos_subclasi_22)


```

```{r}

ggplot(data = delitos_subclasi_22, aes(x = año, y = total, fill = sub_clasi_infrac)) + 
  geom_bar(stat = "identity") +
  labs(title = "22 Contra el orden público", 
       x = "Año", 
       y = "Total de Delitos") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        strip.text = element_text(size = 6))


```

Estos picos podrían estar vinculados a varios factores derivados del contexto post-pandemia. Durante el confinamiento, las restricciones de movimiento y otras medidas sanitarias generaron tensiones entre autoridades y ciudadanos, con numerosos episodios de resistencia frente a las normativas restrictivas.La relajación de las restricciones en 2021 llevó a un incremento generalizado de la actividad social, lo cual también se pudo traducir en un aumento de ciertos tipos de delitos, como altercados y confrontaciones con las autoridades.

Conviene también analizar de forma más detallada los delitos contra la libertad, pues son de los más frecuentes y cuentan con diversas subcategorías.


```{r}

delitos_subclasi_6 <- df_delitos_menores %>%
  filter(!is.na(año) & !is.na(total_delitos) & !is.na(sub_clasi_infrac)) %>%  # Quitamos los NA's
  group_by(año, clasi_infrac, sub_clasi_infrac) %>%  # Agrupamos por año y subclasificación
  summarise(total = sum(total_delitos), .groups = 'drop') %>%  # Sumar el total de infracciones
  filter(clasi_infrac == "6 Contra la libertad")  # Filtrar solo el tipo de delito deseado

print(delitos_subclasi_6)

```


```{r}

ggplot(data = delitos_subclasi_6, aes(x = año, y = total, fill = sub_clasi_infrac)) + 
  geom_bar(stat = "identity") +
  labs(title = "6 Contra la libertad", 
       x = "Año", 
       y = "Total de Delitos") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        strip.text = element_text(size = 6))

```

Como podemos observar, los más comunes son los delitos por amenazas, los cuales van claramente en aumento a lo largo de los años, probablemente por el motivo que ya hemos expuesto anteriormente.

Finalmente, resulta relevante analizar los delitos contra la libertad e indemnidad sexuales, dada su importancia y evolución en los últimos años.

```{r}

delitos_subclasi_8 <- df_delitos_menores %>%
  filter(!is.na(año) & !is.na(total_delitos) & !is.na(sub_clasi_infrac)) %>%  # Quitamos los NA's
  group_by(año, clasi_infrac, sub_clasi_infrac) %>%  # Agrupamos por año y subclasificación
  summarise(total = sum(total_delitos), .groups = 'drop') %>%  # Sumar el total de infracciones
  filter(clasi_infrac == "8 Contra la libertad e indemnidad sexuales")  # Filtrar solo el tipo de delito deseado

print(delitos_subclasi_8)

```



```{r}

ggplot(data = delitos_subclasi_8, aes(x = año, y = total, fill = sub_clasi_infrac)) + 
  geom_bar(stat = "identity") +
  labs(title = "8 Contra la libertad e indemnidad sexuales", 
       x = "Año", 
       y = "Total de Delitos") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        strip.text = element_text(size = 6))

```

Se puede observar que este tipo de delitos ha ido claramente en aumento en los últimos diez años, aunque parece que en 2023 se pudo frenar esta tendencia. Observamos que las subcategorías de agresiones sexuales y abusos sexuales tienen cifras más o menos similares todos los años. En cambio, la subcategoría de color rosa ha ido en aumento, hasta que en el año 2022 se añadió una subcategoría para clasificar los abusos y agresiones sexuales a menores de 16 años. Por tanto, podemos concluir que ha habido un aumento muy significativo de las denuncias de abusos y agresiones sexuales por parte de menores a menores de 16 años. 



A continuación, nos enfocaremos en el análisis bivariante. Es decir, analizaremos las relaciones entre las variables para detectar patrones que nos permitan describir la evolución de la delincuencia juvenil a lo largo del tiempo. Para ello, realizaremos visualizaciones que ilustrarán estas relaciones facilitando su interpretación. 

En primer lugar, realizaremos un análisis de las relaciones entre los tipos de delitos por clasificación. Tenemos un total de 16 clasificaciones diferentes, algunas de las cuales cuentan con subclasificaciones. Como se observa en las gráficas anteriores, la mayoría de las clasificaciones con subcategorías tienen un número reducido de estas, y suele predominar una subclasificación en particular. Por ello, no resulta particularmente relevante analizar las subclasificaciones en estas categorías. Sin embargo, en el caso de los delitos contra el patrimonio y el orden socioeconómico, hay un total de 8 subcategorías, y la frecuencia de cada una de ellas está distribuida de manera más uniforme. Dado que esta es, además, la clasificación más frecuente, resulta interesante realizar un análisis bivariante con las subclasificaciones de este tipo de delito. Por consiguiente, primero llevaremos a cabo un análisis bivariante entre clasificaciones para examinar la correlación entre los distintos tipos de delitos, y posteriormente haremos lo mismo para las subcategorías de los delitos contra el patrimonio.

Para llevar a cabo el análisis por clasificaciones, hemos optado por eliminar las categorías menos relevantes. En el gráfico "Delitos por clasificación" se puede observar que tanto los delitos de falsedades como las faltas contra intereses generales presentan una frecuencia muy baja en los últimos diez años, lo que reduce su relevancia para el análisis. Además, la categoría "Resto de delitos" también muestra una baja frecuencia y aporta poca información al no corresponder a un tipo específico de delito. Por estos motivos, hemos decidido excluir estas categorías, y así poder centrar el análisis en los tipos de delito con mayor impacto  y especificidad.


```{r}
library(tidyr)

# Creamos un nuevo dataframe eliminando las infracciones poco relevantes para el análisis

delitos_clasi_2 <- delitos_clasi %>%
  filter(!grepl('Faltas contra intereses generales',clasi_infrac)) %>% # Quitamos faltas
  filter(!grepl('Falsedades',clasi_infrac)) %>% # Quitamos falsedades
  filter(!grepl('Resto de delitos',clasi_infrac)) # Quitamos resto de delitos
  

print(delitos_clasi_2)

```



```{r}

# Creamos un dataframe que tenga por columnas los delitos y por filas los años

delitos_ancho_clasi <- delitos_clasi_2 %>%
  pivot_wider(names_from = clasi_infrac, values_from = total, values_fill = list(total= 0))
print(delitos_ancho_clasi)

# Calculamos la matriz de correlación

matriz_correlacion_clasi <- delitos_ancho_clasi %>%
     select(-año) %>%  # Excluye la columna de año
     cor()

```



```{r}


# Convertimos la matriz en un dataframe de correlaciones, que ordene las correlaciones en orden decreciente

correlaciones_clasi <- as.data.frame(as.table(matriz_correlacion_clasi)) %>%
  filter(Var1 != Var2) %>%  # Excluye correlaciones de un delito consigo mismo
  mutate(Delitos = ifelse(as.character(Var1) < as.character(Var2), 
                       paste(as.character(Var1), as.character(Var2), sep = " - "), 
                       paste(as.character(Var2), as.character(Var1), sep = " - "))) %>%  # Crea un par ordenado
  distinct(Delitos, .keep_all = TRUE) %>%  # Elimina duplicados
  select(Delitos, Freq) %>% # Nos quedamos solo con las columnas que nos interesan
  arrange(desc(Freq))  # Ordena por el valor de la correlación

# Visualiza las correlaciones más relevantes
print(correlaciones_clasi)



```


Notamos que las correlaciones más significativas se presentan entre las faltas. Esto tiene mucho sentido, ya que, como mencionamos anteriormente, las faltas han ido disminuyendo desde la reforma del código penal en 2015 hasta llegar a desaparecer en los años posteriores. También es notable la alta correlación entre los delitos por lesiones y los delitos contra la libertad. Estos dos tipos de delitos también muestran una correlación muy baja con las faltas contra las personas, lo que refuerza la idea de que las faltas contra las personas se reclasificaron como delitos por lesiones y contra la libertad tras la reforma. Esto explicaría su aumento paralelo junto con la disminución de las faltas. Además, es relevante señalar la fuerte correlación entre los delitos por lesiones y los delitos contra la libertad e indemnidad sexuales. Esto puede deberse a la naturaleza de estos delitos. Ambos tipos de delito a menudo involucran violencia física, lo que puede llevar a una relacion directa en su ocurrencia.  Por ejemplo, los delitos de lesiones pueden ocurrir en el contexto de delitos sexuales, donde la violencia puede ser un factor predominante.

El siguiente gráfico muestra todas las correlaciones entre cada tipo de delito. 

```{r}

library(corrplot)
library(stringr)

plot.new()
dev.off()

delitos<-colnames(delitos_ancho_clasi) %>% .[-1]
numeros<- str_extract(delitos,'[0-9]+')

corrplot(matriz_correlacion_clasi, tl.labels = numeros,tl.cex = 0.7)

```


A continuación, realizaremos el mismo análisis para las diferentes subclasificaciones de los delitos contra el patrimonio y el orden socioeconómico.


```{r}

# Repetimos el análisis para la categoría de delitos contra el patrimonio

delitos_subclasi_13_2<- delitos_subclasi_13 %>% select(-clasi_infrac)

print(delitos_subclasi_13_2)

```


```{r}

# Creamos un dataframe que tenga por columnas los delitos y por filas los años

delitos_ancho_subclasi <- delitos_subclasi_13_2 %>%
  pivot_wider(names_from = sub_clasi_infrac, values_from = total, values_fill = list(total= 0))
print(delitos_ancho_subclasi)

# Calculamos la matriz de correlación

matriz_correlacion_subclasi <- delitos_ancho_subclasi %>%
     select(-año) %>%  # Excluye la columna de año
     cor()

```



```{r}


# Convertimos la matriz en un dataframe de correlaciones
correlaciones_subclasi <- as.data.frame(as.table(matriz_correlacion_subclasi)) %>%
  filter(Var1 != Var2) %>%  # Excluye correlaciones de un delito consigo mismo
  mutate(Delitos = ifelse(as.character(Var1) < as.character(Var2), 
                       paste(as.character(Var1), as.character(Var2), sep = " - "), 
                       paste(as.character(Var2), as.character(Var1), sep = " - "))) %>%  # Crea un par ordenado
  distinct(Delitos, .keep_all = TRUE) %>%  # Elimina duplicados
  select(Delitos, Freq) %>% # Nos quedamos solo con las columnas que nos interesan
  arrange(desc(Freq))  # Ordena por el valor de la correlación

# Visualiza las correlaciones más relevantes
print(correlaciones_subclasi)



```



```{r}

plot.new()
dev.off()

delitos<-colnames(delitos_ancho_subclasi) %>% .[-1]
numeros<- str_extract(delitos,'[0-9]+')

corrplot(matriz_correlacion_subclasi, tl.labels = numeros,tl.cex = 0.7)

```















A continuación, analizaremos las relaciones entre las variables de edad y tipo de delito, con el objetivo de identificar qué delitos son más comunes en función de las distintas edades. Para llevar a cabo este análisis, nos centraremos en los delitos clasificados por subcategorías. Es decir, en aquellos delitos que presentan subclasificaciones, utilizaremos estas para el estudio, mientras que para los delitos que no las tienen, emplearemos su clasificación general.



```{r}

# Delitos vs edades (usando las subclasificaciones) 

delitos_por_edad <- df_delitos_menores %>%
  mutate(clasi_subclasi = ifelse(is.na(as.character(sub_clasi_infrac)), 
                                 as.character(clasi_infrac), 
                                 as.character(sub_clasi_infrac))) %>% # Creamos nueva columna con todas las las subclasificaciones
  mutate(clasi_subclasi = as.factor(clasi_subclasi)) %>%
  filter(!is.na(edad) & !is.na(total_delitos)) %>% # Quitamos los NA's
  group_by(edad, clasi_subclasi) %>%  # Agrupamos segun el tipo de infracción
  summarise(total = sum(total_delitos), .groups = 'drop')  # Sumar el total de infracciones

print(delitos_por_edad)


```

En primer lugar, resulta interesante observar en qué rangos de edad se registra un mayor número de delitos. Para ello, podemos consultar el siguiente gráfico de barras.

```{r}

# En qué edades se delinque mas?

total_delitos_por_edad<-delitos_por_edad %>%
  group_by(edad) %>%
  summarise(total_delitos = sum(total, na.rm = TRUE))

print(total_delitos_por_edad)
  
ggplot(total_delitos_por_edad, aes(x = edad, y = total_delitos, fill = edad)) +
  geom_bar(stat = "identity") +
  labs(title = "Distribución de Delitos por Edad") 
 


```
Observamos que el gráfico revela una clara tendencia crecientea, lo que indica que, a medida que los menores se acercan a la mayoría de edad, la frecuencia de delitos que cometen aumenta.

Asimismo, podemos analizar qué delitos son más frecuentes en función de la edad de los delincuentes. A continuación, presentaremos un gráfico que ilustra los diez delitos más frecuentes en cada grupo de edad y su respectiva frecuencia.

```{r}

top_10_delitos_por_edad <- delitos_por_edad %>%
  group_by(edad) %>%
  slice_max(order_by = total, n = 10) %>%
  ungroup()

print(top_10_delitos_por_edad)


```

```{r}


ggplot(top_10_delitos_por_edad, aes(x = reorder(clasi_subclasi, -total), y = total)) +
  geom_bar(stat = "identity") +
  labs(title = "Top 10 Delitos por Edad",
       x = "Tipo de Delito",
       y = "Frecuencia de Delitos") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  facet_wrap(~ edad, scales = "free_y")  # Facetas por edad, escalas libres en y



```


Notamos que la mayoría de delitos se repiten en cada grupo de edad y siguen una distribución similar. Además, se evidencia un aumento en la frecuencia de los delitos conforme avanzamos en los grupos de edad. Los delitos más comunes en todas las edades son, sin duda, los delitos por lesiones y los robos, seguidos por los hurtos.

Por último, examinaremos la evolución de cada uno de estos delitos a lo largo de los últimos diez años, para cada grupo de edad.

```{r}

delitos_por_edad_i_año <- df_delitos_menores %>%
  mutate(clasi_subclasi = ifelse(is.na(as.character(sub_clasi_infrac)), 
                                 as.character(clasi_infrac), 
                                 as.character(sub_clasi_infrac))) %>% # Creamos nueva columna con todas las las subclasificaciones
  mutate(clasi_subclasi = as.factor(clasi_subclasi)) %>%
  filter(!is.na(edad) & !is.na(total_delitos)) %>% # Quitamos los NA's
  group_by(edad, año, clasi_subclasi) %>%  # Agrupamos segun el tipo de infracción
  summarise(total = sum(total_delitos), .groups = 'drop')  # Sumar el total de infracciones

top_10_delitos_por_edad_i_año<- delitos_por_edad_i_año %>%
  semi_join(top_10_delitos_por_edad, by = c("edad", "clasi_subclasi"))

print(top_10_delitos_por_edad_i_año)

```


```{r}

edades <- c(14, 15, 16, 17)

graficos <- list()

for (ed in edades) {
  datos_edad<-top_10_delitos_por_edad_i_año %>%
  filter(edad==ed)


grafico<-ggplot(data = datos_edad, aes(x = año, y = total, color = clasi_subclasi)) +
    geom_line() + geom_point()+
    labs(title = paste("Evolución del Total de Delitos para Edad",ed),
         x = "Año",
         y = "Total de Delitos",
         color = "Tipo de Delito") +
    theme_minimal() + scale_x_continuous(breaks = seq(2013, 2023, by = 2), limits = c(2013, 2023), labels = as.character(seq(13, 23, by = 2)))

graficos[[paste("Edad", ed)]] <- grafico

print(grafico)
}


```

Se observa que todos los delitos que se repiten para cada grupo de edad, que son la mayoría, siguen una tendencia similar. Se puede observar el aumento de delitos por lesiones en todos los grupos. Además, los robos tienden a disminuir de manera constante en todas las edades. Los hurtos, en cambio, alcanzan sus picos entre 2016 y 2019, para luego descender. En cuanto al resto de delitos, tienen menor frecuencia y se mantienen bastante estables a lo largo del tiempo.



## Análisis de 'outliers', métodos de imputación aplicados y análisis de datos perdidos

### Restricciones de Rango

Primeramente comprobaremos que los valores numéricos se encuentran dentro de los rangos esperados. Utilizando la instrucción 'stopifnot' comporbando los mínimos y máximos esperados.

```{r analisis_outliers_imputacion1, include=FALSE}
# Comprobaciones de limites
stopifnot(min(df_delitos_menores$edad) == 14,
          max(df_delitos_menores$edad) == 17,
          min(df_delitos_menores$año)  == 2013,
          max(df_delitos_menores$año)  == 2023,
          min(df_delitos_menores$total_delitos, na.rm=TRUE)  >= 0)
```

### Restricciones de unicidad. Duplicados (enteros y parciales)

En este apartado analizaremos si hay alguna observación faltante o repetida. Es decir, que tenemos para cada delito (y sus subclasificaciones) un año y una edad específica. Para ello, vamos a contar cuantas veces aparece cada delito esperando obtener un único valor que es 44 (11 años * 4 edades * cada delito en específico). Efectivamente obtenemos dicho valor, para todos los delitos.

```{r analisis_outliers_imputacion2, include=FALSE}
df_delitos_menores %>%
  count(delito_falta, clasi_infrac, sub_clasi_infrac) %>%
  distinct(n)
```

### Validar totales (validación cruzada)

Para validar que los datos se han acondicionado correctamente vamos a sacar las columnas/filas totales originales y compararlas con nuestro dataframe haciendo agrupaciones de los datos y sumas de los valores.

```{r analisis_outliers_imputacion3}
# Obtener los totales de las infracciones
cat("Comparación infracciones totales por año:")
df_totales <- delitos_menores_raw %>%
  filter(is.na(delitos_n2)) %>%
  filter(edad == "Total") %>%
  select(año, total_delitos) %>%
  arrange(año) %>%
  rename(total_proporcionado = total_delitos)

df_suma_totales <- df_delitos_menores %>%
  group_by(año) %>%
  summarize(total_validacion_datos = sum(total_delitos, na.rm=TRUE)) %>%
  arrange(año) %>%
  select(total_validacion_datos)
  

(head(cbind(df_totales, df_suma_totales)))

# Comprobar la agrupación para delitos y faltas
cat("Comparación delitos y faltas totales por año:")
df_totales_infracciones <- delitos_menores_raw %>%
  filter(!is.na(delitos_n2)) %>%
  filter(is.na(delitos_n3)) %>%
  filter(edad == "Total") %>%
  select(delitos_n2, año, total_delitos) %>%
  arrange(año) %>%
  rename(total_proporcionado = total_delitos)

df_suma_totales_infracciones <- df_delitos_menores %>%
  group_by(delito_falta, año) %>%
  summarize(total_validacion_datos = sum(total_delitos, na.rm=TRUE),
            .groups = "drop_last") %>%
  arrange(año)

(head(cbind(df_totales_infracciones, df_suma_totales_infracciones["total_validacion_datos"])))

# Comprobar un tipo de delito
cat("Comparación delitos totales para el delito 13 año:")
df_totales_delito13 <- delitos_menores_raw %>%
  filter(!is.na(delitos_n2)) %>%
  filter(delitos_n3 == "13 Contra el patrimonio y el orden socioeconómico") %>%
  filter(is.na(delitos_n4)) %>%
  filter(edad == "Total") %>%
  select(año, total_delitos) %>%
  arrange(año) %>%
  rename(total_proporcionado = total_delitos)

df_suma_totales_delito13 <- df_delitos_menores %>%
  filter(clasi_infrac == "13 Contra el patrimonio y el orden socioeconómico") %>%
  group_by(clasi_infrac, año) %>%
  summarize(total_validacion_datos = sum(total_delitos, na.rm=TRUE),
            .groups = "drop_last") %>%
  arrange(año) #%>%
  #select(total_validacion_datos)

(head(cbind(df_totales_delito13, df_suma_totales_delito13[3])))

rm(list=c("df_totales", "df_suma_totales", "df_totales_infracciones",
          "df_suma_totales_infracciones", "df_totales_delito13",
          "df_suma_totales_delito13"))
```

Como podemos comprobar los valores coinciden entre los totales proporcionados por la fuente de datos y los nuestros calculados haciendo agrupaciones de los datos acondicionados.

Para el cálculo hemos omitido todas aquellos valores de la columna "total_delitos" que eran NA. Al obtener los mismos resultados podemos confirmar que han considerado como 0 aquellos valores faltantes.

### Validar variables categóricas

En el apartado 2.2.2 hemos averiguado que no tenemos observaciones repetidas, pero ello se puede deber a que hayan fallos tipográficos o de ortografía. Es decir, hemos considerado que "13 delitoo" y "13 delito" no son duplicados. En este apartado trataremos este caso si es necesario.

```{r analisis_outliers_imputacion4, include=FALSE}
df_delitos_menores %>%
  count(delito_falta, clasi_infrac, sub_clasi_infrac) %>%
  mutate(delito_compl = paste(delito_falta,
                              clasi_infrac,
                              sub_clasi_infrac, sep=" ")) %>%
  select(delito_compl, n)
```

Tras echarle un vistazo a la lista de combinaciones "delito_falta" + "clasi_infrac" + "sub_clasi_infrac" podemos confirmar que no hay errores.

### Tratar valores faltantes

Primeramente vamos a visualizar los datos faltantes de la columna "total_delitos"; pues la otra columnas que tiene valores faltantes "sub_clasi_infrac" ya está justificada. A partir de aquí vamos a tratar de razonar si estos datos son faltantes debido a un factor aleatorio o hay un razonamiento detrás.

```{r analisis_outliers_imputacion5_1, out.width="100%"}
vis_miss(df_delitos_menores["total_delitos"])
```

De la visualización podemos apreciar dos grupos de datos faltantes en la columna "total_delitos". De los casos, al estar el dataframe inicialmente organizado por los delitos, podemos decir que:
* El grupo de datos faltantes del final corresponden a las "faltas" que se convirtieron en "delitos". Si recogemos solo las faltas y organizamos por año confirmaremos este caso.
* Pero tenemos otro caso extra que analizaremos a continuación.

Primero la confirmación de las faltas:

```{r analisis_outliers_imputacion5_2, out.width="100%"}
df_delitos_menores %>%
  filter(delito_falta == "Falta") %>%
  arrange(desc(año)) %>%
  select(total_delitos) %>%
  vis_miss() + ggtitle("Valores faltantes de faltas ordenado descendientemente por años")
```

A continuación vamos a tratar el otro grupo de datos faltantes, ignorando las "faltas" y agrupando por delitos:

```{r analisis_outliers_imputacion5_3, out.width="100%"}
delitos_na <- df_delitos_menores %>%
  filter(delito_falta != "Falta") %>%
  group_by(clasi_infrac) %>%
  summarize(na_delitos = sum(is.na(total_delitos))) %>%
  arrange(desc(na_delitos))

head(delitos_na)
```

Podemos ver que todos los datos faltantes corresponden al delito "8 Contra la libertad e indemnidad sexuales". Y dentro de los delitos contra la libertad sexual tenemos solo datos faltantes en dos delitos en concreto "BIS Abusos y agresiones sexuales a menores de 16 años" y "Prostitución y corrupción menores"

```{r analisis_outliers_imputacion5_4}
delitos_8 <- df_delitos_menores %>%
  filter(str_detect(clasi_infrac, "8")) %>%
  group_by(sub_clasi_infrac) %>%
  summarize(na_delitos = sum(is.na(total_delitos))) %>%
  arrange(desc(na_delitos))

head(delitos_8)

```
Si ahora cogemos y los ordenamos estos dos por años podemos ver el efecto de la Ley Orgánica 4/2023 donde se incluyen en estos delitos a los menores de edad.

```{r analisis_outliers_imputacion5_5, out.width="100%"}
delitos_sexuales_faltantes <- c("8.2 BIS Abusos y agresiones sexuales a menores de 16 años",
                                "8.5 Prostitución y corrupción menores")
df_delitos_menores %>%
  filter(sub_clasi_infrac %in% delitos_sexuales_faltantes) %>%
  arrange(desc(año)) %>%
  select(total_delitos) %>%
  vis_miss() + ggtitle("Valores faltantes de faltas ordenado descendientemente por años")
```

Finalmente podemos confirmar que los dos casos de daltos faltantes están justificados. Uno debido a la reforma relacionada con la clasificación de las infracciones en faltas o delitos, y el otro caso debido a LO 4/2023, donde a partir de 2023 se consideran nuevos delitos en menores, faltando datos previamente.


## Visualización Explicatoria
```{r visualizacion_explicatoria}
# WIP:
#   - Visualización enfocada a los objetivos (encontrar una respuesta al problema). (TODOS)
#
# - NOTA: Junto a la visualización se debe aportar una explicación.
```

# Conclusiones
(TODOS)
WIP:
 - Conclusiones finales.
   - Objetivos.
   - Proyecto.
 - NOTA: Visualizaciones interactivas para finalizar/resumir, puede ser un buen punto.
