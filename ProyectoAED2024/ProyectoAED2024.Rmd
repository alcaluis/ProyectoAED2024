---
title: ProyectoAED2024
subtitle: "Análisis Exploratorio de Datos. Máster en Ciencia de Datos - UV"
authors:
  - name: LUIS ALBACETE CABALLERO
  - name: CARLOS RIBES GARCÍA
  - name: JOAN PEDRO BRUIXOLA
affiliation:
  - num: 1
    address: |
      Universitat de València. ETSE.
    email: alcaluis@alumni.uv.es
  - num: 2
    address: |
      Universitat de València. ETSE.
    email: carigar4@alumni.uv.es
  - num: 3
    address: |
      Universitat de València. ETSE.
    email: jopebrui@alumni.uv.es
authorcitation: |
  Albacete, L; Ribes, C; Pedro, J.
simplesummary: |
  Estudio de los delitos causados por menores en España entre 2013 y 2023.
abstract: |
  Proyecto de tratamiento de datos para la asignatura de Análisis exploratorio
  de datos. El tópico es la delincuencia en España provocado por menores de entre
  14 y 17 años (ambos inclusives). Donde se estudiarán los delitos causados con
  mayor frecuencia.
keywords: |
  Delito; Delincuencia; Menores; Datos; Ciencia de Datos;
authorcontributions: |
  WIP. En que hemos contribuido cada uno.
output: 
  rticles::mdpi_article:
    extra_dependencies: longtable
---

# Introducción

## Definición proyecto y planteamiento de preguntas (objetivos)

La delincuencia en España es un tema de conversación latente. Aunque no lo es tanto, pero sigue siendo importante, es hablar de la edad del delincuente. En este estudio analizaremos los diferentes tipos de delito ocasionados por menores de entre 14 y 17 años durante los 10 últimos años. Los objetivos del estudio es responder a las siguientes preguntas:

1. ¿Cuáles son los delitos más frecuentes y que edades lo frecuentan? ¿Siguen siendo recientes o han disminuido?
2. Analizar los picos de delitos y relacionarlos con hechos reales. (Buscar sucesos, leyes)
3. Encontrar tendencias entre los años.
4. ...

WIP: Definir el problema y los objetivos del estudio

## Carga de librerías y datos
```{r intro_setup_carga}
# Carga de librerias
librerias <- c("readr",       # Lectura de ficheros con formato
               "dplyr",       # Gramática de manipulación de datos
               "ggplot2")     # Visualización mediante gráficas elegantes
pacman::p_load(char=librerias)

# Carga de datos
col_names <- c("delitos_n1", "delitos_n2", "delitos_n3",
               "delitos_n4", "delitos_n5", "edad",
               "año", "total_delitos")

delitos_menores_raw <- read_delim(
  file = "../data/delitos_menores_2013_2023.csv", 
  delim = ";",
  escape_double = FALSE,
  trim_ws = TRUE,                        # Espacios y tabulaciones eliminados.
  show_col_types = FALSE,                # Omitir mensajes en carga de datos.
  col_names = col_names,                 # Si proporcionamos nombres de columnas hemos de
                                         # saltarnos la primera fila (skip=1).
  skip = 1,
  locale = locale(grouping_mark = "."))  # Locale nos permitirá leer debidamente
                                         # los millares.
```

## Estudio y acondicionamiento de los datos
WIP (TODOS, #01-Introduccion):
   - Análisis de la estructura y valores iniciales de los datos.
   - Acondicionamiento y preparación de los datos.
   - Validación datos acondicionados

### Análisis de la estructura y valores iniciales de los datos.
```{r intro_analisis_inicial_1}
# Análisis de la estructura y valores iniciales de los datos.
summary(delitos_menores_raw)
# str(delitos_menores_raw)     # STR no nos aporta información adicional
# glimpse(delitos_menores_raw) # Lo mismo sucede con GLIMPSE
```
Gracias a "summary" podemos apreciar qué columnas contienen NAs y si los valores (de las columnas numéricas) entran dentro de lo esperado (min, max, median, ...).


Teniendo para la columna **año** valores esperados, desde 2013 hasta 2023 y la media obviamente en 2018. Respecto a la columna **total_delitos**, podemos apreciar que tiene un número relevante de valores faltantes (210) y confirmamos que los valores se han importado correctamente (manteniendo los millares).


Además hemos identificado que la columna **edad** se ha importado como tipo "character". Tras hacer una visualización del archivo nos damos cuenta que los años se han importado como "14 años" agregando el sustantivo para todos los valores y en algunos casos agregando un "Total". Acondicionamiento de la columna será necesario.


Las columnas restantes, que son de tipo "character", representan el delito en sus distintos niveles. Habremos de factorizar estas variable categóricas.


El uso de la función "str" o "glimpse" en este caso no nos ha aportado información adicional.


```{r intro_analisis_inicial_2}
# 1. delitos_n1
table(delitos_menores_raw$delitos_n1, useNA = "always")

# 2. delitos_n2
table(delitos_menores_raw$delitos_n2, useNA = "always")

# 3. delitos_n3, N4, N5
tail(table(delitos_menores_raw$delitos_n3, useNA = "always"), 2)
tail(table(delitos_menores_raw$delitos_n4, useNA = "always"), 2)
tail(table(delitos_menores_raw$delitos_n5, useNA = "always"), 2)

# 4. edad
table(delitos_menores_raw$edad, useNA = "always")

# 5. año
table(delitos_menores_raw$año, useNA = "always")
```
De las diferentes columnas podemos decir que:

* **delitos_n1**: la primera columna no nos aporta valor alguno al solo tener un valor. Más adelante será eliminada.
* **delitos_n2**: esta columna nos servirá para hacer el primer filtrado y quedarnos con solo los delitos y faltas cometidas. Omitiendo los totales calculados. Sus valores pueden ser reemplazados en valores más claros.
* **delitos_n3, n4, y n5**: ayudan a clasificar los delitos en subtipos de infracción. Sin embargo, podemos ver como a mayor nivel de detalle más valores faltantes. Esto se debe a que un nivel de clasificación tan preciso no es necesario para describir todos los delitos.

La columna **delitos_n5** no será necesaria. Aporta muy poca información y el análisis no requerirá tanto nivel de detalle para una infracción.

* **edad**: todos los datos de esta columna son uniformes y esperados (ningún valor faltante). Finalmente se eliminarán aquellas instancias que representen un total y se convertirá la columna a tipo numérico.

```{r intro_analisis_inicial_3}
# 6. total_delitos
df_total_delitos <- delitos_menores_raw %>%
  filter(startsWith(delitos_n3, "13")) %>%
  filter(edad=="14 años") %>%
  filter(año==2013) %>%
  mutate(delitos_n4 = ifelse(!is.na(delitos_n4),
                             substring(delitos_n4, 1, 4),
                             NA))

knitr::kable(df_total_delitos[c(4,5,8)], format = "latex", 
             booktabs = TRUE, 
             caption = "Caso delitos 'Contra el patrimonio y el orden 
                        socioeconómico' en 2013 por delincuentes de 14 años", 
             align = 'lll', centering = TRUE,
             table.envir = "table", position = "H")

```

* **total**: respecto a esta columna pese a que no hayamos utilizado ninguna instrucción, hemos mediante visualización del fichero analizado un caso en concreto para definir la naturaleza de esta columna. Ya vimos anteriormente, gracias a otras columnas, que hay agrupaciones internas de los datos calculando los totales. Pero eso no es todo. Podemos apreciar que el total de un delito, es la suma de todas sus subclasificaciones.

Es decir, el total de "13.2 Robos", es igual a la suma de "13.2.1" y "13.2.2", a su vez el delito contra el patrimonio es la suma de los delitos "13.1", "13.2", ... Este hecho agrega redundancia a los datos. Por ende no solo tendremos que eliminar las filas que representen totales pero también aquellas filas que son las agrupaciones de otras con el objeto de tener un conjunto __Tidy__.

En resumen, las columnas de delitos n1 y n5 no son necesarias y pueden ser eliminadas sin problemas. Hemos averiguado que los delitos de N5 se suman para los delitos de N4. Las columnas de delitos restantes serán convertidas a factor. La columna edad será modificada para mayor fidelidad al dato. 

### Acondicionamiento y preparación de los datos
```{r intro_acondicionamiento}
df_delitos_menores <- delitos_menores_raw %>%
  # Retiramos las filas que se dividan/clasifiquen hasta el nivel 5
  filter(is.na(delitos_n5)) %>%
  filter(!is.na(delitos_n3)) %>%
  # Selección de características/variables relevantes
  select(-c(delitos_n1, delitos_n5)) %>%

  # Renombramiento de las columnas
  rename(delito_falta = delitos_n2,          # Delito o Falta
         clasi_infrac = delitos_n3,          # Primer nivel de clasifiación
         sub_clasi_infrac = delitos_n4) %>%  # Segundo nivel de clasifiación
  
  # Filtrado, retiramos las columnas que ya están pre-calculadas.
  # Caso edad = "Total"
  # Caso "nivel_n1" era un "total" y los demás niveles de delito "NA"
  # Caso "nivel_n2" era un "total"
  filter(edad != "Total") %>%
  filter(!is.na(delito_falta)) %>%
  filter(!is.na(clasi_infrac)) %>%
  
  # Reemplazo de valores
  mutate(
    # valores entendibles para "delito_falta"
    delito_falta = case_when(delito_falta == "A Delitos" ~ "Delito",
                             delito_falta == "B Faltas" ~ "Falta"),
    # Eliminamos " años" y pasamos a numérico
    edad = as.numeric(substring(edad, 1, 2))
  ) %>%
  
  # Convertimos a factores
  mutate(
    delito_falta = as.factor(delito_falta),
    clasi_infrac = as.factor(clasi_infrac),
    sub_clasi_infrac = as.factor(sub_clasi_infrac)
  )

  #Eliminamos las filas con los totales de las subcategorías
  seleccion<-c()
  
  for (type in unique(df_delitos_menores$clasi_infrac) ){
    
    vectoraux<- df_delitos_menores$sub_clasi_infrac[df_delitos_menores$clasi_infrac==type]
    print(vectoraux)
    print( !is.na(vectoraux) )
    if ( sum(!is.na( vectoraux ) > 0 )){
        seleccion<-c(seleccion, !is.na( vectoraux ))
    } else{
        seleccion<-c(seleccion, rep(TRUE, times=length(vectoraux)))
    }
    
  }

  df_delitos_menores<- df_delitos_menores[seleccion,]

# WIP. Eliminacion aquellas columnas que tienen subclasisifaciones.
```

### Validación datos acondicionados

Para validar que los datos se han cargado correctamente vamos a sacar las columnas totales precaculadas y compararlas con 

```{r intro_acondicionamiento_validacion}
# Obtener los totales
df_totales <- delitos_menores_raw %>%
  filter(edad == "Total")
```

# Análisis

## Análisis de las variables
```{r analisis_variables}
# WIP:
#   - Análisis de las variables (individualmente, explicación de los datos,
#                                estadísticos.) (CARLOS)
#   - Análisis de las variables (relaciones) (JOAN)
# 
#
# - NOTA: Se debe hacer uso de una "Visualización temprana (exploratoria)"
#   de los datos. 
# - NOTA: Junto a la visualización se debe aportar una explicación.
```


A continuación, analizaremos las relaciones entre las variables para detectar patrones que nos permitan describir la evolución de la delincuencia juvenil a lo largo del tiempo. Para ello, realizaremos visualizaciones que ilustrarán estas relaciones facilitando su interpretación. 

En primer lugar, estudiaremos la distribución de delitos y faltas a lo largo de los años. El siguiente gráfico de barras permite visualizar la cantidad total de incidentes entre 2013 y 2023.


```{r}
# Filtramos para quedarnos con el total de delitos y faltas por año.

total_infrac_años <- df_delitos_menores %>%
  filter(!is.na(año) & !is.na(delito_falta) & !is.na(total_delitos)) %>% # Quitamos los NA's
  group_by(año, delito_falta) %>%  # Agrupamos segun el tipo de infracción
  summarise(total = sum(total_delitos), .groups = 'drop')  # Sumar el total de infracciones

print(total_infrac_años)


```

```{r}

ggplot(data = total_infrac_años, aes(x = año, y = total, fill = delito_falta)) + 
  geom_bar(stat = "identity", position = "dodge") + 
  labs(title = "Distribución de Delitos vs. Faltas por Año", 
       x = "Año", 
       y = "Total de Incidencias") + scale_x_continuous(breaks = seq(min(df_delitos_menores$año), max(df_delitos_menores$año), by = 1))

```
Como podemos observar, hay una clara tendencia creciente de los delitos de menores desde el 2016 hasta el 2019. En el 2020 hay una gran disminución de delitos. Esto se debe, sin duda, a la cuarentena que hubo durante la pandemia del COVID-19. Pero, a partir del 2021, notamos que la cantidad de delitos vuelve a subir, tomando unas cifras similares a las del 2019. En general, podemos observar un notable aumento de delitos juveniles en los últimos diez años. Por otra parte, notamos que el número de faltas va disminuyendo hasta el año 2017, y a partir del 2018 no hay registros sobre faltas.

Esta tendencia de aumento de delitos y disminución de faltas puede deberse a diferentes motivos. El cambio mas notable se observa entre el 2015 y el 2016. Este fenómeno puede deberse a la reforma del Código Penal en España del 2015, en la cual se llevó a cabo la supresión de muchas infracciones consideradas faltas, que pasaron a ser clasificadas como delitos leves. Esto explicaría el aumento de delitos en contraposición con la disminución de faltas a partir del año 2015. 


```{r}

delitos_clasi <- df_delitos_menores %>%
  filter(!is.na(año) & !is.na(total_delitos)) %>% # Quitamos los NA's
  group_by(año, clasi_infrac, sub_clasi_infrac) %>%  # Agrupamos segun el tipo de infracción
  summarise(total = sum(total_delitos), .groups = 'drop')  # Sumar el total de infracciones

print(delitos_clasi)

```

```{r}


ggplot(data = delitos_clasi, aes(x = clasi_infrac, y = total)) + 
  geom_bar(stat = "identity") +
  labs(title = "Delitos por Tipo y Subclasificación", 
       x = "Tipo de Delito", 
       y = "Total de Delitos") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) + facet_wrap(~ año)

# Probar con evolución por años de cada tipo de delito

```


## Análisis de 'outliers', métodos de imputación aplicados y análisis de datos perdidos
```{r analisis_outliers_imputacion}
# WIP:
#   - Análisis de outliers, métodos de imputación y datos perdidos.
# (si procede) (LUIS)
```

## Visualización Explicatoria
```{r visualizacion_explicatoria}
# WIP:
#   - Visualización enfocada a los objetivos (encontrar una respuesta al problema). (TODOS)
#
# - NOTA: Junto a la visualización se debe aportar una explicación.
```

# Conclusiones
(TODOS)
WIP:
 - Conclusiones finales.
   - Objetivos.
   - Proyecto.
 - NOTA: Visualizaciones interactivas para finalizar/resumir, puede ser un buen punto.
